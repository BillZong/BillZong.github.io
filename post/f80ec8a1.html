<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> GraphQL API构建示例(2) · 知易行难，一路向前</title><meta name="description" content="GraphQL API构建示例(2) - Bill Zong"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico?v=2021"><link rel="stylesheet" href="/css/style.css"><link rel="search" type="application/opensearchdescription+xml" href="https://billzong.github.io/atom.xml" title="知易行难，一路向前"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="wrap"><header><h1 class="title">知易行难，一路向前</h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">主页</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">归档</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/billzong" target="_blank">Github主页</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">GraphQL API构建示例(2)</h1><div class="post-info">2021-04-08</div><div class="post-content"><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><ol>
<li><a href="./d3239b62.html">设计一个<code>GraphQL schema</code>方案</a></li>
<li><strong>设计并实现一个存储数据的后端数据方案</strong></li>
<li>实现一个从<strong>1</strong>翻译到<strong>2</strong>的解析器 </li>
<li>实现API的授权</li>
</ol>
<p>前文已经提了基本的示例需求描述，以及基本数据结构和方案。</p>
<p>当前这篇文章会从后端数据存储切入，更详细的剖析如何构建这个示例的 GraphQL 解决方案。</p>
<h2 id="数据库选择"><a href="#数据库选择" class="headerlink" title="数据库选择"></a>数据库选择</h2><p>GraphQL 的查询内容，往往决定了后端的存储方式。所以找到一个合适的可以支持所有（尽可能全面的）GraphQL Queries 的数据库，是很关键的一步。</p>
<p>考虑到管理和扩容问题，尽量使用云服务。可选的方案有：</p>
<ul>
<li>NoSQL DB Service<ul>
<li>优势：存储规模自动伸缩</li>
<li>劣势：所有数据集聚合查询时会异常地会特别困难，也就意味着在 SQL 中相对简单的<code>avg()</code>之类的查询在这里成了性能瓶颈。</li>
</ul>
</li>
<li>NoSQL DB Service + <a href="https://github.com/elastic/elasticsearch" target="_blank" rel="noopener">Elasticsearch 分布式数据查询</a><ul>
<li>细节：NoSQL DB 负责数据存储和修改，<code>Elasticsearch</code>负责数据聚合。绝大部分查询使用<code>Elasticsearch</code>，少量直接使用数据<code>key</code>访问的查询使用 NoSQL DB。</li>
<li>优势：高效的全文本查询。</li>
<li>劣势：同步问题会增加复杂度。另外，<code>Elasticsearch</code>是开源实现，目前暂时没有<code>serverless</code>部署实现，需要自己配置部署并解决缩放问题。</li>
</ul>
</li>
<li>云 SQL DB，如 Azure/Google Cloud/Amazon Aurora Serverless<ul>
<li>优势：适用于关系型数据</li>
<li>劣势：全文本检索效率相对较低。特别是在分布式SQL DB上。</li>
</ul>
</li>
</ul>
<p>实际参考案例：<br><strong>Stack Overflow</strong> 最初是架构在 SQL 全文检索上，当性能碰到天花板后，则将查询架构迁移到了<code>Elasticsearch</code>。</p>
<p>再回到具体的查询需求，进行更细致的分解：</p>
<ul>
<li>findLocation（byGPS）要求我们在定位半径范围内进行餐馆查询。</li>
<li>位置（类型）要求我们返回收藏餐馆的个数和平均评级。</li>
<li>有几个查询（包括子查询）返回分页响应。</li>
</ul>
<p>考虑到用户可能会更倾向于使用名称而不是GPS坐标查询位置范围内的信息（全文检索），我们也更倾向于使用<code>Elasticsearch</code>来作为查询的基础架构。</p>
<p>我们将使用<code>ID</code>和类型（<code>LOCATION</code>或<code>REVIEW</code>）在单个表中实现每个记录（位置和评论）。 然后将其传输到<code>ElasticSearch Service</code>进行搜索。 大多数查询将由<code>ElasticSearch Service</code>处理，尽管有一些查询（例如，某个位置的评论的分页查询）将通过<code>NoSQL DB Service</code>查询完成。</p>
<h2 id="实现数据存储层"><a href="#实现数据存储层" class="headerlink" title="实现数据存储层"></a>实现数据存储层</h2><p>对于存储层的架构，我们有几项技术可以参考。</p>
<ul>
<li><a href="https://github.com/aws-amplify/amplify-cli" target="_blank" rel="noopener">amplify-cli</a>，<code>GraphQL API</code>模型映射和代码生成。</li>
<li><a href="https://aws.amazon.com/cn/cloudformation/" target="_blank" rel="noopener">cloud formation</a>，允许配置后端的资源，但无法配置前端的资源。</li>
<li><a href="https://github.com/serverless/serverless" target="_blank" rel="noopener">serverless framework</a>，前后端资源都支持，配置也相对容易。</li>
</ul>
<p>至于其他的技术，暂时未调研可行性。但基本的参考思路是一致的。</p>
<p><code>amplify-cli</code>的功能可以节约我们大量的开发工作。</p>
<p>以下是配置文件<code>serverless.yaml</code>，内容较长，故分段说明。</p>
<h3 id="Amazon-Dynamo-数据库服务配置"><a href="#Amazon-Dynamo-数据库服务配置" class="headerlink" title="Amazon Dynamo 数据库服务配置"></a>Amazon Dynamo 数据库服务配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DynamoDBTable:</span><br><span class="line"> Type: AWS::DynamoDB::Table</span><br><span class="line"> Properties:</span><br><span class="line">   TableName: $&#123;self:custom.api&#125;</span><br><span class="line">   KeySchema:</span><br><span class="line">     - AttributeName: id</span><br><span class="line">       KeyType: HASH</span><br><span class="line">     - AttributeName: typeName</span><br><span class="line">       KeyType: RANGE</span><br><span class="line">   AttributeDefinitions:</span><br><span class="line">     - AttributeName: id</span><br><span class="line">       AttributeType: S</span><br><span class="line">     - AttributeName: typeName</span><br><span class="line">       AttributeType: S</span><br><span class="line">   ProvisionedThroughput:</span><br><span class="line">     ReadCapacityUnits: $&#123;self:custom.ddb_readIOPS&#125;</span><br><span class="line">     WriteCapacityUnits: $&#123;self:custom.ddb_writeIOPS&#125;</span><br><span class="line">   StreamSpecification: # 这个流配置是重要的触发器，即数据新增、更新、删除时，会触发并发送给流</span><br><span class="line">     StreamViewType: NEW_AND_OLD_IMAGES</span><br></pre></td></tr></table></figure>

<h3 id="自定义配置项"><a href="#自定义配置项" class="headerlink" title="自定义配置项"></a>自定义配置项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">custom:</span><br><span class="line">  # The base name of the API for resource generation - can&#39;t include dashes</span><br><span class="line">  # [a-zA-Z0-9]+ only</span><br><span class="line">  api: $&#123;self:provider.stage&#125;RestaurantReviews</span><br><span class="line">  # ES Domain, must match [a-z][a-z0-9\-]+</span><br><span class="line">  es_domain: $&#123;self:provider.stage&#125;-restaurant-reviews</span><br><span class="line">  # The number of instances to launch into the ElasticSearch domain</span><br><span class="line">  es_instanceCount: 1</span><br><span class="line">  # The type of instance to launch into the ElasticSearch domain</span><br><span class="line">  es_instanceType: &quot;t2.small.elasticsearch&quot;</span><br><span class="line">  # The size in GB of the EBS volumes that contain the data</span><br><span class="line">  es_ebsVolumeGB: 20</span><br><span class="line">  # The number of read IOPS the DynamoDB table should support.</span><br><span class="line">  ddb_readIOPS: 5</span><br><span class="line">  # The number of write IOPS the DynamoDB table should support.</span><br><span class="line">  ddb_writeIOPS: 5</span><br></pre></td></tr></table></figure>

<h3 id="ElasticSearch配置项"><a href="#ElasticSearch配置项" class="headerlink" title="ElasticSearch配置项"></a>ElasticSearch配置项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">ElasticSearchStreamingLambdaIAMRole:</span><br><span class="line">      Type: AWS::IAM::Role # 授权服务</span><br><span class="line">      Properties:</span><br><span class="line">        RoleName: $&#123;self:custom.api&#125;-ESStreamingLambdaRole</span><br><span class="line">        AssumeRolePolicyDocument:</span><br><span class="line">          Version: &quot;2012-10-17&quot;</span><br><span class="line">          Statement:</span><br><span class="line">            - Effect: Allow</span><br><span class="line">              Principal:</span><br><span class="line">                Service: &quot;lambda.amazonaws.com&quot;</span><br><span class="line">              Action: &quot;sts:AssumeRole&quot;</span><br><span class="line">        Policies:</span><br><span class="line">          - PolicyName: ElasticSearchAccess</span><br><span class="line">            PolicyDocument:</span><br><span class="line">              Version: &quot;2012-10-17&quot;</span><br><span class="line">              Statement:</span><br><span class="line">                - Action:</span><br><span class="line">                    - &quot;es:ESHttpPost&quot;</span><br><span class="line">                  Effect: Allow</span><br><span class="line">                  Resource:</span><br><span class="line">                    - &quot;arn:aws:es:#&#123;AWS::Region&#125;:#&#123;AWS::AccountId&#125;:domain&#x2F;$&#123;self:custom.es_domain&#125;&#x2F;_bulk&quot;</span><br><span class="line">          - PolicyName: DynamoDBStreamAccess</span><br><span class="line">            PolicyDocument:</span><br><span class="line">              Version: &quot;2012-10-17&quot;</span><br><span class="line">              Statement:</span><br><span class="line">                - Action:</span><br><span class="line">                    - &quot;dynamodb:DescribeStream&quot;</span><br><span class="line">                    - &quot;dynamodb:GetRecords&quot;</span><br><span class="line">                    - &quot;dynamodb:GetShardIterator&quot;</span><br><span class="line">                    - &quot;dynamodb:ListStreams&quot;</span><br><span class="line">                  Effect: Allow</span><br><span class="line">                  Resource:</span><br><span class="line">                    - &#123; Fn::GetAtt: [ DynamoDBTable, StreamArn ]&#125;</span><br><span class="line">          - PolicyName: CloudWatchLogsAccess</span><br><span class="line">            PolicyDocument:</span><br><span class="line">              Version: &quot;2012-10-17&quot;</span><br><span class="line">              Statement:</span><br><span class="line">                - Action:</span><br><span class="line">                    - &quot;logs:CreateLogGroup&quot;</span><br><span class="line">                    - &quot;logs:CreateLogStream&quot;</span><br><span class="line">                    - &quot;logs:PutLogEvents&quot;</span><br><span class="line">                  Effect: Allow</span><br><span class="line">                  Resource:</span><br><span class="line">                    - &quot;arn:aws:logs:#&#123;AWS::Region&#125;:#&#123;AWS::AccountId&#125;:*&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Amazon-Lambda-function-配置"><a href="#Amazon-Lambda-function-配置" class="headerlink" title="Amazon Lambda function 配置"></a>Amazon Lambda function 配置</h3><p>对应到OpenWhisk则是trigger</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">functions:</span><br><span class="line">  dynamodb_stream:</span><br><span class="line">    handler: elasticsearch.lambda_handler # 回调方法</span><br><span class="line">    name: $&#123;self:custom.api&#125;-dynamodb_stream_handler</span><br><span class="line">    description: Stream data from DynamoDB to ElasticSearch</span><br><span class="line">    runtime: python3.6</span><br><span class="line">    memorySize: 128</span><br><span class="line">    role: ElasticSearchStreamingLambdaIAMRole # 授权角色</span><br><span class="line">    environment:</span><br><span class="line">      ES_ENDPOINT: &#123; Fn::GetAtt: [ ElasticSearchDomain, DomainEndpoint ]&#125;</span><br><span class="line">      DEBUG: 1</span><br><span class="line">    events:</span><br><span class="line">      - stream:</span><br><span class="line">          type: dynamodb</span><br><span class="line">          arn: &#123; Fn::GetAtt: [ DynamoDBTable, StreamArn ]&#125;</span><br></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a class="prev" href="/post/12d311d1.html">PREV</a><a class="next" href="/post/d3239b62.html">NEXT</a></div><div class="copyright"><p>© 2021 PEACE & LOVE</p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>, <a href="https://github.com/jeremyfan/hexo-theme-still" target="_blank">theme</a> by <a href="https://github.com/jeremyfan" target="_blank">Bill Zong</a>.</p></div></footer></div></body></html>