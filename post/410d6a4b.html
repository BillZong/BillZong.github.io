<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> go-ethereum日志库调研 · 知易行难，一路向前</title><meta name="description" content="go-ethereum日志库调研 - Bill Zong"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico?v=2021"><link rel="stylesheet" href="/css/style.css"><link rel="search" type="application/opensearchdescription+xml" href="https://billzong.github.io/atom.xml" title="知易行难，一路向前"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="知易行难，一路向前" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="知易行难，一路向前" type="application/rss+xml">
</head><body><div class="wrap"><header><h1 class="title">知易行难，一路向前</h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">主页</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">归档</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/billzong" target="_blank">Github主页</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">go-ethereum日志库调研</h1><div class="post-info">2021-04-12</div><div class="post-content"><h1 id="log15"><a href="#log15" class="headerlink" title="log15"></a>log15</h1><figure class="highlight plain"><figcaption><span>"github.com/inconshreveable/log15"```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 特性</span><br><span class="line">- KV对方式的结构化日志</span><br><span class="line">- 通过继承+自定义上下文的方式达成定制化</span><br><span class="line">- 允许懒加载(日志内容可不提前分配内存和运算, 但仅限于&#96;&#96;&#96;value&#96;&#96;&#96;, &#96;&#96;&#96;key&#96;&#96;&#96;上使用&#96;&#96;&#96;Lazy&#96;&#96;&#96;无效)</span><br><span class="line">- 处理接口配置简单自定义</span><br><span class="line">- (不同等级)终端输出颜色支持</span><br><span class="line">- 文件日志&#x2F;流日志&#x2F;系统日志&#x2F;网络日志内建支持</span><br><span class="line">- 日志多分流输出(方便同时输出到流&#x2F;文件等)</span><br><span class="line">- 日志缓存输出(减少过量IO)</span><br><span class="line">- 写入日志失败退出处理(避免丢失日志的概率)</span><br><span class="line"></span><br><span class="line">## 常用接口</span><br><span class="line">&#96;&#96;&#96;go</span><br><span class="line">func Debug(msg string, ctx ...interface&#123;&#125;)</span><br><span class="line">type Ctx map[string]interface&#123;&#125; &#x2F;&#x2F; 输入键值对的方式, 便于人类阅读</span><br><span class="line">&#x2F;&#x2F; 允许你推迟运算</span><br><span class="line">type Lazy struct &#123;</span><br><span class="line">    Fn interface&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 格式化设置</span><br><span class="line">type Format interface &#123;</span><br><span class="line">    Format(r *Record) []byte</span><br><span class="line">&#125;</span><br><span class="line">func FormatFunc(f func(*Record) []byte) Format &#x2F;&#x2F; 动态格式化设置</span><br><span class="line">&#x2F;&#x2F; 处理接口, 后续一堆实现了该接口的内容, 可用于自定义处理方式</span><br><span class="line">type Handler interface &#123;</span><br><span class="line">    Log(r *Record) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// all loggers can have key/value context</span></span><br><span class="line">srvlog := log.New(<span class="string">"module"</span>, <span class="string">"app/server"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// all log messages can have key/value context</span></span><br><span class="line">srvlog.Warn(<span class="string">"abnormal conn rate"</span>, <span class="string">"rate"</span>, curRate, <span class="string">"low"</span>, lowRate, <span class="string">"high"</span>, highRate)</span><br><span class="line"></span><br><span class="line"><span class="comment">// child loggers with inherited context</span></span><br><span class="line">connlog := srvlog.New(<span class="string">"raddr"</span>, c.RemoteAddr())</span><br><span class="line">connlog.Info(<span class="string">"connection open"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// lazy evaluation</span></span><br><span class="line">connlog.Debug(<span class="string">"ping remote"</span>, <span class="string">"latency"</span>, log.Lazy&#123;pingRemote&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// flexible configuration</span></span><br><span class="line">srvlog.SetHandler(log.MultiHandler(</span><br><span class="line">    log.StreamHandler(os.Stderr, log.LogfmtFormat()),</span><br><span class="line">    log.LvlFilterHandler(</span><br><span class="line">        log.LvlError,</span><br><span class="line">        log.Must.FileHandler(<span class="string">"errors.json"</span>, log.JsonFormat()))))</span><br></pre></td></tr></table></figure>
<p>上面的输出结果如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WARN[06-17|21:58:10] abnormal conn rate                       module=app/server rate=0.500 low=0.100 high=0.800</span><br><span class="line">INFO[06-17|21:58:10] connection open                          module=app/server raddr=10.0.0.1</span><br></pre></td></tr></table></figure>

<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>主分支会一直修正, 如果需要使用稳定的版本, 应使用vendor进行管理</li>
<li>目前版本<code>v2.14</code>依然不支持<code>rotate</code></li>
<li>堆栈信息输出有限(目前为2层), 且无法调整(可能是内存方面的考虑)</li>
</ul>
<h1 id="go-ethreum修改"><a href="#go-ethreum修改" class="headerlink" title="go-ethreum修改"></a>go-ethreum修改</h1><h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>新增<code>trace</code>日志等级</li>
<li><code>critical</code>日志等级输出后, 退出程序</li>
</ul>
<h2 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h2><ul>
<li>依然不支持<code>rotate</code>, 有移动端开发社区的童鞋就这个问题进行了修改, 把文件日志使用<a href="https://github.com/natefinch/lumberjack" target="_blank" rel="noopener">lumberjack</a>进行了代替. 具体替换改动见<a href="https://github.com/PombeirP/status-go/commit/49b0e0747ce6074abee71dbf130342a69acfb4ea" target="_blank" rel="noopener">此链接</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/post/749896c7.html">上一篇</a><a class="next" href="/post/7742e199.html">下一篇</a></div><div class="copyright"><p>© 2021 PEACE & LOVE</p><p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>, <a href="https://github.com/jeremyfan/hexo-theme-still" target="_blank">theme</a> by <a href="https://github.com/jeremyfan" target="_blank">Bill Zong</a>.</p></div></footer></div></body></html>